# Driplo Development Rules

**Project**: Luxury fashion marketplace (SvelteKit + Supabase)  
**Read First**: `docs/PRODUCTION_PLAN.md` for status, `docs/IMPLEMENTED.md` for what's done

---

## Critical Rules

### 1. **Use MCP Tools First - Always**
- **Svelte code** → `mcp_svelte_list-sections` + `mcp_svelte_get-documentation` BEFORE writing
- **Supabase** → Use `mcp_supabase_*` tools (apply_migration, execute_sql, etc.) - NO CLI
- **External libs** → `mcp_context7_resolve-library-id` + `mcp_context7_get-library-docs` BEFORE coding
- **Never guess** - Read official docs via MCP, then implement

### 2. **Tech Stack - No Exceptions**
- **Svelte 5** runes (`$state`, `$props`, `$derived`, `$effect`) - NO slots, use snippets
- **SvelteKit 2** - Use `error()`, `redirect()`, `satisfies PageServerLoad`
- **TypeScript** strict mode - All files typed
- **Tailwind CSS** - Utility classes only, NO custom CSS
- **Supabase** - PostgreSQL + RLS + Storage + Realtime

### 3. **Documentation Workflow**
```
Before coding → Read docs/PRODUCTION_PLAN.md (know current phase)
After coding  → Update docs/IMPLEMENTED.md (short bullets, what changed)
Never create → "TASK_X_COMPLETE.md", "FEATURE_FIX.md", "WEEK_X_SUMMARY.md"
```

### 4. **Supabase = MCP Only**
```typescript
// ✅ CORRECT - Use MCP tools
mcp_supabase_apply_migration()  // For migrations
mcp_supabase_execute_sql()      // For queries
mcp_supabase_list_tables()      // For schema info

// ❌ WRONG - No CLI, no psql, no npx supabase
npx supabase db push  // DON'T USE
psql "postgresql://..." // DON'T USE
```

### 5. **Svelte 5 = Read Docs First**
```typescript
// Before writing ANY Svelte component:
1. mcp_svelte_list-sections()  // See all available docs
2. mcp_svelte_get-documentation(["relevant", "sections"])
3. Write code using official patterns

// Example: Building a form with validation
→ Fetch: ["runes", "forms", "$state", "$derived", "$effect"]
→ Read the docs, then implement
```

### 6. **File Changes**
- Edit files with `replace_string_in_file` (3-5 lines context before/after)
- Create files with `create_file` (full content)
- **Never** write file contents in chat - use tools

### 7. **Search & Debugging**
```
semantic_search()   // Natural language search in codebase
grep_search()       // Exact string/regex search
read_file()         // Read specific lines (50-100 lines at a time)
get_errors()        // Check TypeScript/lint errors
```

### 8. **Performance Rules**
- Database queries < 100ms (use indexes, check with `EXPLAIN ANALYZE`)
- Search dropdowns < 200ms (use optimized RPCs like `search_products_fast`)
- Debounce user input: 150ms (not 300ms)
- Cache client-side (60s TTL for search results)

### 9. **Code Quality**
- **DRY**: Don't repeat yourself - create reusable components
- **KISS**: Keep it simple - no over-engineering
- **Test**: Verify in browser before saying "done"
- **Performance**: Measure before/after (use `performance.now()`)

### 10. **Communication**
- Be direct - no corporate speak
- Show code diffs when fixing bugs
- Update todo list (`manage_todo_list`) for multi-step work
- Mark todos complete IMMEDIATELY after finishing

---

## Workflow Example

```typescript
// ❌ BAD WORKFLOW
User: "Make a form with validation"
AI: *writes 200 lines of Svelte without checking docs*
AI: *uses deprecated patterns*
Result: Broken code, doesn't follow Svelte 5 best practices

// ✅ GOOD WORKFLOW  
User: "Make a form with validation"
AI: mcp_svelte_list-sections() // Check what's available
AI: mcp_svelte_get-documentation(["forms", "$state", "$derived"])
AI: *reads official patterns*
AI: *writes code following docs*
AI: *tests in browser*
AI: Updates docs/IMPLEMENTED.md with "Added form validation using $derived"
Result: Working code, follows best practices
```

---

## Common Mistakes to Avoid

1. ❌ Writing Svelte without reading docs → Use MCP
2. ❌ Using Supabase CLI → Use `mcp_supabase_*` tools
3. ❌ Creating completion docs → Update `IMPLEMENTED.md`
4. ❌ Slow search (300ms debounce) → Use 150ms + optimize RPC
5. ❌ `data.supabase` in client code → Use `createBrowserSupabaseClient()`
6. ❌ Over-engineering → Keep it simple, ship fast

---

## Quick Reference

**Project Structure**: Turborepo monorepo (apps/web, packages/ui, packages/database)  
**Database**: Supabase project `koowfhsaqmarfdkwsfiz`  
**Docs**: `docs/` folder (7 core files, keep them updated)  
**MCP Servers**: Supabase, Svelte, Context7 (always use them)

**Current Phase**: Check `docs/PRODUCTION_PLAN.md`
