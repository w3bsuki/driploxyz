# Project Sitemap - Ideal Structure

This sitemap defines the **IDEAL** final directory layout for the SvelteKit 2 + Svelte 5 monorepo following official best practices. This represents the target structure we're working toward through the refactor process.

## Legend

- ‚úÖ Already aligned with best practices
- üîÑ Needs refactoring to match ideal structure  
- üóëÔ∏è Should be removed (duplicate or unnecessary)
- üìù Needs documentation or cleanup
- ‚ö†Ô∏è Requires careful migration

## Philosophy

This structure follows **SvelteKit Best Practices**:
1. **Single Source of Truth** - No duplicate assets across apps
2. **Colocation** - Keep related code together in routes
3. **Clear Boundaries** - Separate server-only code with `$lib/server`
4. **Type Safety** - Generated types via `$types.d.ts`
5. **Package Isolation** - Shared packages are truly reusable

## Final Monorepo Layoutitemap

This sitemap locks in the final directory layout for the SvelteKit¬†2 + Svelte¬†5 monorepo with Supabase, Paraglide, Tailwind¬†v4, and shared UI packages. Treat it as the single source of truth before executing any refactor work.

## Legend

- ‚úÖ Moved or confirmed in the new structure
- üîÑ Action required to finish alignment
- üóëÔ∏è Remove or archive after verification

## Final Monorepo Layout

### Apps Structure (SvelteKit Applications)

| Path | Status | Purpose | Key Principles |
|------|--------|---------|----------------|
| `/apps/web/src/routes` | ‚úÖ | Customer-facing routes, layouts, pages | **Colocation**: Keep route-specific components in route folders |
| `/apps/web/src/lib` | üîÑ | Reusable utilities & components via `$lib` | **Server isolation**: Use `$lib/server` for server-only code |
| `/apps/web/src/lib/server` | üîÑ | Server-only code (Supabase clients, auth) | **Never** imported by client code |
| `/apps/web/src/params` | ‚úÖ | Custom parameter matchers | For advanced routing validation |
| `/apps/web/static` | ‚úÖ | Static assets (images, fonts, robots.txt) | Served as-is, no processing |
| `/apps/admin/src` | ‚úÖ | Admin panel with service-role Supabase auth | Uses `$lib/server` pattern |
| `/apps/docs/src` | ‚úÖ | Documentation site (pre-rendered) | Static generation |

### Packages Structure (Shared Code)

| Path | Status | Purpose | Export Pattern |
|------|--------|---------|----------------|
| `/packages/ui/src/lib` | ‚úÖ | **Publishable** Svelte 5 component library | Exports via `package.json` "exports" field |
| `/packages/ui/src/lib/components` | ‚úÖ | Runes-based UI components | Fully typed with `$props()`, `$derived()` |
| `/packages/i18n` | ‚úÖ | **Single source** for i18n (Paraglide) | ‚ö†Ô∏è NO duplicates in apps |
| `/packages/i18n/paraglide` | ‚úÖ | Generated i18n output | Auto-generated, DO NOT edit manually |
| `/packages/core/src` | üîÑ | Business logic services | Pure functions, no framework deps |
| `/packages/domain/src` | ‚úÖ | Type definitions & validators | Shared types across apps |
| `/packages/database/src` | ‚úÖ | Supabase generated types | Auto-generated via `supabase gen types` |
| `/packages/database/src/generated` | ‚úÖ | Type generation output | Regenerated via Turbo pipeline |
| `/packages/testing` | ‚úÖ | Vitest & Playwright configs | Shared test setup |

### Infrastructure & Tooling

| Path | Status | Purpose | Notes |
|------|--------|---------|-------|
| `/supabase/migrations` | ‚úÖ | SQL migration files | Version controlled |
| `/supabase/functions` | ‚úÖ | Edge functions | Deno runtime |
| `/scripts` | üîÑ | Build & automation scripts | ESM-only, no legacy CJS |
| `/docs` | üìù | Project documentation | Keep updated with changes |

## Critical Principles from SvelteKit Best Practices

### 1. ‚úÖ Route Colocation (Already Good)
```
src/routes/
  blog/
    [slug]/
      +page.svelte          ‚Üê Page component
      +page.ts              ‚Üê Load function
      +page.server.ts       ‚Üê Server-only load
      BlogComments.svelte   ‚Üê Route-specific component (colocated!)
```
**Rationale**: Components used by a single route should live WITH that route, not in a global `$lib/components`.

### 2. ‚ö†Ô∏è $lib vs $lib/server Separation (Needs Work)
```
src/lib/
  components/        ‚Üê Client-safe components only
  utils/            ‚Üê Pure utilities
  stores/           ‚Üê Svelte stores
  server/           ‚Üê ‚ö†Ô∏è SERVER-ONLY code
    database.ts     ‚Üê Supabase service role client
    auth.ts         ‚Üê Server-side auth helpers
```
**Action Required**: Audit all `$lib` imports to ensure server code is in `$lib/server`.

### 3. ‚úÖ Single Source of Truth - i18n (CONFIRMED CORRECT)
- ‚úÖ `/packages/i18n` is the ONLY source for Paraglide
- ‚úÖ NO `apps/web/src/paraglide` directory (verified deleted)
- ‚úÖ All apps import via `@repo/i18n`

### 4. üîÑ State Management (Needs Review)
- ‚ùå Avoid global stores shared across SSR requests
- ‚úÖ Use `$derived()` for computed values (not `$effect()`)
- ‚úÖ Use context API for passing state down component tree
- ‚ö†Ô∏è URL search params for filters, sorting (needs verification)

### 5. üîÑ Type Safety (Partially Complete)
- ‚úÖ Use `$types.d.ts` imports: `import type { PageProps } from './$types'`
- üîÑ Ensure all `load` functions have correct type annotations
- üîÑ Fix type errors identified in check command

## Refactor Action Items

### Phase 1: i18n Centralization ‚úÖ COMPLETE
- ‚úÖ Confirmed NO duplicate `apps/web/src/paraglide` directory
- ‚úÖ All imports use `@repo/i18n` package
- üîÑ Fix missing i18n message keys (separate task)

### Phase 2: Server/Client Code Separation üîÑ IN PROGRESS
1. Audit `src/lib` in all apps for server-only code
2. Move server code to `src/lib/server`
3. Update imports to use `$lib/server` alias
4. Verify build catches any incorrect client imports

### Phase 3: Component Colocation üìù PLANNED
1. Identify components used by only one route
2. Move them from `$lib/components` into route folders
3. Keep only truly shared components in packages/ui

### Phase 4: Type Error Resolution üîÑ IN PROGRESS
1. Fix missing i18n message keys
2. Add proper type annotations to load functions
3. Fix nullable type handling
4. Run `pnpm --filter web run check` until zero errors

## SvelteKit Architecture Guidelines

### Route Organization (Per SvelteKit Standards)

```
apps/web/src/routes/
  (marketing)/                    ‚Üê Layout group (no URL segment)
    +layout.svelte               ‚Üê Marketing layout
    +page.svelte                 ‚Üê Homepage
    about/
      +page.svelte               ‚Üê /about
  
  (auth)/                         ‚Üê Auth layout group
    login/
      +page.svelte               ‚Üê /login
      +page.server.ts            ‚Üê Server-side auth
    signup/
      +page.svelte
  
  (app)/                          ‚Üê Protected app layout
    +layout.server.ts            ‚Üê Auth check
    dashboard/
      +page.svelte
    profile/
      [id]/
        +page.svelte             ‚Üê /profile/[id]
        +page.server.ts          ‚Üê Load user data
        ProfileHeader.svelte     ‚Üê ‚úÖ Route-colocated component
        ProfileStats.svelte      ‚Üê ‚úÖ Route-colocated component
  
  api/                            ‚Üê API routes (avoid if using remote functions)
    +server.ts                   ‚Üê REST-style endpoints (legacy)
```

### Load Function Best Practices

```typescript
// ‚úÖ CORRECT: Type-safe server load
// src/routes/blog/[slug]/+page.server.ts
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ params, locals }) => {
  const post = await locals.supabase
    .from('posts')
    .select('*')
    .eq('slug', params.slug)
    .single();
  
  return { post };
};
```

```svelte
<!-- ‚úÖ CORRECT: Type-safe props -->
<!-- src/routes/blog/[slug]/+page.svelte -->
<script lang="ts">
  import type { PageProps } from './$types';
  
  let { data }: PageProps = $props();
</script>

<h1>{data.post.title}</h1>
```

### State Management Patterns

```typescript
// ‚ùå WRONG: Global mutable state
let currentUser = null; // This is shared across ALL requests!

// ‚úÖ CORRECT: Context-based state
import { setContext, getContext } from 'svelte';

// In +layout.svelte
setContext('user', () => data.user);

// In child component
const user = getContext('user');
```

### Server vs Client Code

```typescript
// ‚ùå WRONG: Server code in $lib
// src/lib/database.ts
import { SUPABASE_SERVICE_ROLE_KEY } from '$env/static/private';
// This will fail if imported client-side!

// ‚úÖ CORRECT: Server code in $lib/server
// src/lib/server/database.ts
import { SUPABASE_SERVICE_ROLE_KEY } from '$env/static/private';
// SvelteKit prevents client imports

// ‚úÖ CORRECT: Client import
// src/lib/api.ts
import { PUBLIC_SUPABASE_URL } from '$env/static/public';
// Safe to import anywhere
```

## Package Architecture (Component Library Pattern)

### `/packages/ui` - Svelte Component Library

Following **@sveltejs/package** best practices:

```
packages/ui/
  src/
    lib/                    ‚Üê Public API (becomes dist/)
      components/
        Button.svelte       ‚Üê Exported component
        Input.svelte
      index.ts              ‚Üê Main export
    routes/                 ‚Üê Demo/docs site (not published)
      +page.svelte          ‚Üê Component showcase
  
  package.json
    "exports": {
      ".": {
        "types": "./dist/index.d.ts",
        "svelte": "./dist/index.js"
      }
    }
```

**Key Points**:
- ‚úÖ `src/lib` is the publishable part
- ‚úÖ `src/routes` is for demos/docs only
- ‚úÖ Export via `package.json` "exports" field
- ‚úÖ Generate types with `svelte-package`

### `/packages/i18n` - Internationalization (Paraglide)

```
packages/i18n/
  messages/               ‚Üê Source messages (en.json, es.json)
  paraglide/             ‚Üê ‚úÖ GENERATED output (DO NOT EDIT)
    messages.js
    runtime.js
  src/
    index.ts             ‚Üê Re-exports paraglide runtime
  package.json
```

**Critical Rules**:
- ‚ö†Ô∏è NO duplicate paraglide folders in apps
- ‚úÖ All apps import from `@repo/i18n`
- ‚úÖ Messages defined ONCE in `packages/i18n/messages`

### `/packages/database` - Supabase Types

```
packages/database/
  src/
    generated/           ‚Üê ‚úÖ Auto-generated (supabase gen types)
      supabase.ts
    index.ts             ‚Üê Re-exports types
  
  scripts/
    generate-types.ts    ‚Üê Turbo pipeline task
```

### `/packages/core` - Business Logic

```
packages/core/
  src/
    services/
      product.service.ts     ‚Üê Pure business logic
      order.service.ts
    utils/
      validation.ts          ‚Üê Framework-agnostic helpers
```

**Important**: 
- ‚ùå No SvelteKit-specific imports (`$app/*`)
- ‚ùå No Svelte components
- ‚úÖ Pure TypeScript/JavaScript
- ‚úÖ Testable with Vitest

### `/packages/domain` - Shared Types

```
packages/domain/
  src/
    types/
      user.ts
      product.ts
    validators/
      schemas.ts         ‚Üê Zod schemas
```

## Infrastructure & Configuration

### Root Configuration Files

| File | Purpose | Status |
|------|---------|--------|
| `pnpm-workspace.yaml` | Monorepo workspace definition | ‚úÖ |
| `turbo.json` | Build orchestration & caching | ‚úÖ |
| `tsconfig.json` | Base TypeScript config | ‚úÖ |
| `.gitignore` | ‚ö†Ô∏è Ensure `.svelte-kit`, `dist`, `node_modules` | üîÑ |

### Per-App Configuration

Each SvelteKit app MUST have:
```
apps/web/
  svelte.config.js        ‚Üê Vite plugin, adapters, aliases
  vite.config.ts          ‚Üê Vite-specific config
  tsconfig.json           ‚Üê Extends base, adds $lib alias
  playwright.config.ts    ‚Üê E2E tests (if applicable)
  vitest.config.ts        ‚Üê Unit tests (if applicable)
```

**Critical `svelte.config.js` patterns**:
```javascript
import adapter from '@sveltejs/adapter-vercel';
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte';

export default {
  preprocess: vitePreprocess(),
  kit: {
    adapter: adapter(),
    alias: {
      '$lib': './src/lib',
      '$lib/server': './src/lib/server'  // ‚ö†Ô∏è Critical!
    }
  }
};
```

## Verification & Testing Strategy

### Per-Phase Verification Steps

#### Phase 1: i18n Centralization ‚úÖ COMPLETE
```bash
# ‚úÖ Verify no duplicate paraglide directory
Test-Path "apps/web/src/paraglide"  # Should be False

# ‚úÖ Verify imports use @repo/i18n
grep -r "from '@repo/i18n'" apps/web/src --include="*.ts" --include="*.svelte"

# üîÑ Run type check (will show missing i18n keys)
pnpm --filter web run check
```

#### Phase 2: Server/Client Separation
```bash
# Find potential server-only code in $lib
grep -r "SUPABASE_SERVICE_ROLE\|env/static/private" apps/web/src/lib --include="*.ts"

# Verify $lib/server exists and is used
ls apps/web/src/lib/server

# Build should catch client imports of server code
pnpm --filter web run build
```

#### Phase 3: Component Colocation
```bash
# Identify single-use components
# (Manual review of imports)

# After moving: verify imports updated
pnpm --filter web run check
pnpm --filter web run build
```

#### Phase 4: Type Error Resolution
```bash
# Zero errors goal
pnpm --filter web run check

# Build succeeds
pnpm --filter web run build

# Tests pass
pnpm --filter web run test
```

## Common Anti-Patterns to Avoid

### ‚ùå Don't: Global Mutable State on Server
```typescript
// ‚ùå WRONG - Shared across all users!
let currentUser = null;

export function setUser(user) {
  currentUser = user;  // BUG: All users see this!
}
```

### ‚úÖ Do: Use Context or Return from Load
```typescript
// ‚úÖ CORRECT - Per-request state
export const load: LayoutServerLoad = async ({ locals }) => {
  return {
    user: locals.user  // Scoped to this request
  };
};
```

### ‚ùå Don't: Side Effects in Load Functions
```typescript
// ‚ùå WRONG
export const load: PageLoad = async () => {
  globalStore.set(data);  // Side effect!
  return { data };
};
```

### ‚úÖ Do: Pure Load Functions
```typescript
// ‚úÖ CORRECT
export const load: PageLoad = async () => {
  return { data };  // Just return data
};
```

### ‚ùå Don't: Duplicate Assets Across Apps
```
‚ùå apps/web/src/paraglide/     ‚Üê NO!
‚ùå apps/admin/src/paraglide/   ‚Üê NO!
‚úÖ packages/i18n/paraglide/    ‚Üê YES!
```

### ‚úÖ Do: Single Source Package
```typescript
// All apps import from same package
import * as i18n from '@repo/i18n';
```

## Maintenance Guidelines

### When Adding a New Route
1. Create route folder: `src/routes/feature/`
2. Add `+page.svelte` (and `+page.ts`/`+page.server.ts` if needed)
3. **Colocate** route-specific components in same folder
4. Use `$lib` only for truly shared utilities
5. Use `$lib/server` for any server-only code
6. Add types via `import type { PageProps } from './$types'`

### When Adding a Shared Component
1. Is it used by multiple routes? ‚Üí `packages/ui`
2. Is it app-specific but reused? ‚Üí `apps/[app]/src/lib/components`
3. Is it route-specific? ‚Üí Keep it in the route folder!

### When Adding Server Code
1. ‚úÖ Create in `src/lib/server/`
2. ‚úÖ Import private env vars here
3. ‚úÖ Use service role Supabase clients here
4. ‚ùå NEVER import server code in client components

### Before Each Commit
```bash
# Run these checks
pnpm lint
pnpm --filter web run check
pnpm --filter web run build
pnpm test

# Ensure no build artifacts committed
git status | grep -E ".svelte-kit|dist|node_modules"  # Should be empty
```

## Migration Tracking

| Task | Status | Blocker | Next Step |
|------|--------|---------|-----------|
| i18n centralization | ‚úÖ | None | Document missing keys |
| Fix type errors | üîÑ | 2000+ errors | Prioritize by severity |
| Server/client audit | üìù | None | Start with $lib scan |
| Component colocation | üìù | Type errors | After types fixed |
| Remove legacy code | üìù | Testing | After refactor complete |

## Success Criteria

‚úÖ **Project is "perfect" when**:
1. Zero TypeScript errors (`pnpm check`)
2. All builds succeed (`pnpm build`)
3. All tests pass (`pnpm test`)
4. No duplicate assets (verified by grep)
5. Clear `$lib` vs `$lib/server` separation
6. Components colocated with routes where possible
7. Packages follow official `@sveltejs/package` pattern
8. All imports use workspace packages (`@repo/*`)

---

**Last Updated**: 2025-10-11  
**Next Review**: After Phase 2 completion
