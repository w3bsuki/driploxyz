<!DOCTYPE html>
<html>
<head>
    <title>Image Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin-top: 20px; padding: 10px; background: #f0f0f0; }
        img { max-width: 200px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Image Upload Optimization Test</h1>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <div id="result"></div>
    
    <script>
        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: false });
                
                let objectUrl = null;
                
                const cleanup = () => {
                    if (objectUrl) {
                        URL.revokeObjectURL(objectUrl);
                        objectUrl = null;
                    }
                };
                
                img.onload = async () => {
                    try {
                        // Calculate new dimensions (max 1920px)
                        const maxSize = 1920;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxSize || height > maxSize) {
                            const ratio = Math.min(maxSize / width, maxSize / height);
                            width = Math.round(width * ratio);
                            height = Math.round(height * ratio);
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        if (!ctx) {
                            throw new Error('Could not get canvas context');
                        }
                        
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Try WebP with timeout
                        const webpPromise = new Promise((res) => {
                            const timeout = setTimeout(() => res(null), 3000);
                            canvas.toBlob(
                                (blob) => {
                                    clearTimeout(timeout);
                                    res(blob);
                                },
                                'image/webp',
                                0.85
                            );
                        });
                        
                        const webpBlob = await webpPromise;
                        
                        if (webpBlob) {
                            cleanup();
                            resolve({ blob: webpBlob, type: 'webp', width, height });
                        } else {
                            // Fallback to JPEG
                            canvas.toBlob(
                                (blob) => {
                                    cleanup();
                                    if (blob) {
                                        resolve({ blob, type: 'jpeg', width, height });
                                    } else {
                                        reject(new Error('Failed to compress image'));
                                    }
                                },
                                'image/jpeg',
                                0.85
                            );
                        }
                    } catch (error) {
                        cleanup();
                        reject(error);
                    }
                };
                
                img.onerror = () => {
                    cleanup();
                    reject(new Error('Failed to load image'));
                };
                
                objectUrl = URL.createObjectURL(file);
                img.src = objectUrl;
            });
        }
        
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<h3>Processing...</h3>';
            
            const results = [];
            
            for (const file of files) {
                try {
                    console.log(`Processing ${file.name}...`);
                    const startTime = performance.now();
                    const optimized = await optimizeImage(file);
                    const endTime = performance.now();
                    
                    const originalSize = file.size;
                    const optimizedSize = optimized.blob.size;
                    const reduction = ((originalSize - optimizedSize) / originalSize * 100).toFixed(1);
                    const time = (endTime - startTime).toFixed(0);
                    
                    results.push({
                        name: file.name,
                        originalSize: (originalSize / 1024).toFixed(1) + ' KB',
                        optimizedSize: (optimizedSize / 1024).toFixed(1) + ' KB',
                        reduction: reduction + '%',
                        format: optimized.type.toUpperCase(),
                        dimensions: `${optimized.width}x${optimized.height}`,
                        time: time + 'ms',
                        url: URL.createObjectURL(optimized.blob)
                    });
                } catch (error) {
                    console.error(`Failed to optimize ${file.name}:`, error);
                    results.push({
                        name: file.name,
                        error: error.message
                    });
                }
            }
            
            // Display results
            let html = '<h3>Results:</h3>';
            for (const result of results) {
                if (result.error) {
                    html += `<div style="color: red;">❌ ${result.name}: ${result.error}</div>`;
                } else {
                    html += `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                            <strong>✅ ${result.name}</strong><br>
                            Original: ${result.originalSize}<br>
                            Optimized: ${result.optimizedSize} (${result.format})<br>
                            Reduction: ${result.reduction}<br>
                            Dimensions: ${result.dimensions}<br>
                            Time: ${result.time}<br>
                            <img src="${result.url}" alt="Optimized">
                        </div>
                    `;
                }
            }
            
            resultDiv.innerHTML = html;
        });
    </script>
</body>
</html>