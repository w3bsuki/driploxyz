 K:\driplo-turbo-1\docs/svelte5-kit2-best-practices.md (+164 -0)                                                                                                                                         
    1     +# Svelte 5 + SvelteKit 2 Best Practices                                                                                                                                                          
    3     +Opinionated, pragmatic guidance for this codebase (Svelte 5 runes, SvelteKit 2, Tailwind CSS v4, TypeScript). Mobile-first by default.                                                           
    5     +## Core Principles                                                                                                                                                                               
    7     +- Simplicity: prefer small, focused components and stores.                                                                                                                                       
    8     +- Mobile-first: design and test at 360px before desktop.                                                                                                                                         
    9     +- SSR-first: make things SSR-safe; guard browser-only logic.                                                                                                                                     
    10    +- Type-safety: avoid `any`; model inputs/outputs and events.                                                                                                                                     
    11    +- Performance: derive state instead of effects; lazy-load where it matters.                                                                                                                      
    13    +## Svelte 5 Runes                                                                                                                                                                                
    15    +- State: use `$state` for local mutable state.                                                                                                                                                   
    16    +  - Keep state minimal; compute everything else with `$derived`.                                                                                                                                 
    17    +- Derivations: prefer `$derived(...)` over `$effect` for computed values.                                                                                                                        
    18    +  - Example: `const isLoggedIn = $derived(!!$authState.user)`.                                                                                                                                   
    19    +- Effects: use `$effect` only for side-effects (subscriptions, timers, DOM, services) and always return cleanups.                                                                                
    20    +  - Guard CSR-only effects: `if (!browser) return;`.                                                                                                                                             
    21    +- Props: destructure with `$props()` and give a typed interface.                                                                                                                                 
    22    +  - Avoid optional `any`; prefer concrete types or narrow interfaces.                                                                                                                            
    23    +- Events: use Svelte event directives `on:*` for DOM and components.                                                                                                                             
    24    +  - `on:click` supports modifiers (`|preventDefault`, `|stopPropagation`, `|once`, `|capture`, `|passive`).                                                                                      
    25    +  - When attaching to Svelte components, `on:click` is required; `onclick` becomes a prop.                                                                                                       
    27    +## Component Architecture                                                                                                                                                                        
    29    +- Single responsibility: avoid “god components.” Extract menus, panels, and buttons.                                                                                                             
    30    +- Slots first: expose composition (header, actions) via `<slot>` props.                                                                                                                          
    31    +- Event contract: components dispatch named events (`createEventDispatcher`) instead of leaking internals.                                                                                       
    32    +- Props vs stores: components take props; stores are for cross-cutting/app state only.                                                                                                           
    33    +- Avoid deep imports: import via public entry points.                                                                                                                                            
    35    +## SvelteKit 2 Data & Navigation                                                                                                                                                                 
    37    +- Load functions: use `+page.server.ts` for server-only data; `+page.ts` for universal.                                                                                                          
    38    +  - Keep loads lean; return only what the page needs.                                                                                                                                            
    39    +  - Use `throw redirect(status, location)` for auth redirects.                                                                                                                                   
    40    +  - For errors, `throw error(status, message)` with typed shapes.                                                                                                                                
    41    +- Form actions: prefer progressive enhancement (`enhance`) for mutations.                                                                                                                        
    42    +  - Validate with Zod on the server; return structured errors.                                                                                                                                   
    43    +- Navigation: use `goto(url, opts)` instead of `window.location` for client nav.                                                                                                                 
    44    +- Hooks: centralize auth/session in `handle`, `handleFetch`, and `handleError`.                                                                                                                  
    45    +- Caching: set `cache-control` where possible; leverage `depends()` for invalidation.                                                                                                            
    47    +## Stores & Realtime                                                                                                                                                                             
    49    +- Create small, focused stores per concern (auth, notifications, toasts).                                                                                                                        
    50    +- In components: subscribe via `$store` or `store.subscribe` inside `$effect` with cleanup.                                                                                                      
    51    +- Realtime/services: init/destroy in `$effect` with `if (!browser) return;` guard to prevent SSR execution.                                                                                      
    53    +## TypeScript                                                                                                                                                                                    
    55    +- Props: define `interface Props` and destructure via `$props<Props>()`.                                                                                                                         
    56    +- No `any`: model minimal domain types (e.g., `User`, `Profile`) or narrow shapes.                                                                                                               
    57    +- Keep event payloads typed (`dispatch<CustomEvent<Payload>>`).                                                                                                                                  
    58    +- Enable strictness (already in repo config); fix implicit `any` and `unknown`.                                                                                                                  
    60    +## Tailwind CSS v4                                                                                                                                                                               
    62    +- CSS-first: use `@import 'tailwindcss'`, `@plugin`, `@theme`, `@utility`, and `@source` (as this repo does).                                                                                    
    63    +- Design tokens: define colors/spacing/radii in `@theme`; reuse in components.                                                                                                                   
    64    +- Prefer utilities over custom CSS; only use `@apply` in leaf utility classes.                                                                                                                   
    65    +- Audit classes: use valid v4 utilities (e.g., `shadow-sm`, `backdrop-blur-sm`)                                                                                                                  
    66    +  - Avoid non-existent sizes like `shadow-xs` / `backdrop-blur-xs`.                                                                                                                              
    67    +- Content scan: keep `@source` tight to avoid bloated builds.                                                                                                                                    
    68    +- Motion: minimize heavy blurs/animations on mobile (battery/perf).                                                                                                                              
    70    +## Accessibility                                                                                                                                                                                 
    72    +- Semantics: use proper elements (`button`, `nav`, `header`, etc.).                                                                                                                              
    73    +- State: wire `aria-expanded`, `aria-controls`, `aria-busy`, etc., where relevant.                                                                                                               
    74    +- Keyboard: support `Enter/Space` on interactive elements; close menus on `Escape` and `on:focusout`.                                                                                            
    75    +- Focus: manage focus when opening dialogs/menus; restore on close.                                                                                                                              
    76    +- Icons: mark decorative SVGs `aria-hidden="true"`.                                                                                                                                              
    77    +- Color contrast: ensure 4.5:1 minimum for text; verify in dark/light contexts.                                                                                                                  
    79    +## Mobile-First                                                                                                                                                                                  
    81    +- Layouts: design at 360–400px first; avoid horizontal scroll.                                                                                                                                   
    82    +- Targets: minimum `44px` height for taps; ample spacing.                                                                                                                                        
    83    +- Search: available and prominent on mobile when present on desktop.                                                                                                                             
    84    +- Performance: avoid parallax/heavy shadows/filters on low-end devices.                                                                                                                          
    85    +- Safe areas: pad footers/headers with `env(safe-area-inset-*)` when fixed.                                                                                                                      
    87    +## Performance                                                                                                                                                                                   
    89    +- Derive > Effect: compute UI state with `$derived`, not effects.                                                                                                                                
    90    +- Keyed each: always key list items with stable ids.                                                                                                                                             
    91    +- Lazy mount: conditionally render heavy elements (panels, modals) when opened.                                                                                                                  
    92    +- Code split: dynamic import large feature components if not on initial route.                                                                                                                   
    93    +- Avoid thrash: debounce inputs, don’t write state inside tight loops or `scroll` without throttling.                                                                                            
    95    +## Patterns to Prefer                                                                                                                                                                            
    97    +- Event directives: `on:click={handler}` with modifiers where needed.                                                                                                                            
    98    +- Conditional rendering: `{#if open}{...}{/if}` instead of toggling `hidden` for expensive DOM.                                                                                                  
    99    +- Derived flags: `const canSell = $derived(canSellHelper($profile))`.                                                                                                                            
    100   +- Navigation: `<a href>` for normal links, `goto` for programmatic.                                                                                                                              
    101   +- Data prefetch: `data-sveltekit-preload-data="hover"`/`preload-code` on anchors for snappier UX.                                                                                                
    103   +## Patterns to Avoid                                                                                                                                                                             
    105   +- Monolithic components that mix auth, nav, notifications, language, and toasts.                                                                                                                 
    106   +- `onclick` on Svelte components (becomes a prop, not a listener).                                                                                                                               
    107   +- Unused imports/props/effects.                                                                                                                                                                  
    108   +- Client-only side effects on the server (missing `browser` guard).                                                                                                                              
    109   +- Wide `any` types and leaking server objects into the client bundle.                                                                                                                            
    111   +## Testing                                                                                                                                                                                       
    113   +- Unit: use Testing Library for components (DOM-first assertions).                                                                                                                               
    114   +- a11y: add `axe` checks for critical UI (header, menus, modals).                                                                                                                                
    115   +- Integration: Playwright for flows (auth, search, sell item).                                                                                                                                   
    116   +- Keep tests fast and deterministic; stub network/services.                                                                                                                                      
    118   +## Error Handling & UX                                                                                                                                                                           
    120   +- SvelteKit: throw `error(status, message)` from loads/actions and show friendly pages.                                                                                                          
    121   +- Toasts: use a central toast store for transient messages; auto-dismiss.                                                                                                                        
    122   +- Retries: for realtime/services, surface retry actions and backoff.                                                                                                                             
    124   +## Internationalization                                                                                                                                                                          
    126   +- Single source: read language from i18n store; avoid duplicate local state.                                                                                                                     
    127   +- SSR: initialize language tag on the server; sync on the client via a guarded `$effect`.                                                                                                        
    128   +- Avoid FOUC: gate UI that depends on language until initialized.                                                                                                                                
    130   +## Auth                                                                                                                                                                                          
    132   +- Server-first: read session in `+layout.server.ts` and expose minimal data via `load`.                                                                                                          
    133   +- Client: subscribe to an auth store; guard effects with `browser`.                                                                                                                              
    134   +- Redirect rules in hooks/loads; never rely on client-only redirects for protected pages.                                                                                                        
    136   +## File & Naming Conventions                                                                                                                                                                     
    138   +- Files: `kebab-case.svelte` / `kebab-case.ts`.                                                                                                                                                  
    139   +- Components in `src/lib/components/` grouped by feature.                                                                                                                                        
    140   +- Public exports from index files; avoid deep nested imports.                                                                                                                                    
    142   +## Checklists                                                                                                                                                                                    
    144   +### Component PR Checklist                                                                                                                                                                       
    146   +- [ ] Uses `$state`/`$derived` appropriately; minimal `$effect`.                                                                                                                                 
    147   +- [ ] Event handlers use `on:*` and necessary modifiers.                                                                                                                                         
    148   +- [ ] SSR-safe: no browser-only code without `browser` guard.                                                                                                                                    
    149   +- [ ] Props and events are typed; no `any`.                                                                                                                                                      
    150   +- [ ] a11y basics: semantics, focus, keyboard, labels.                                                                                                                                           
    151   +- [ ] Mobile layout verified at 360–400px; no horizontal scroll.                                                                                                                                 
    152   +- [ ] No unused imports/props; CSS classes are valid in Tailwind v4.                                                                                                                             
    154   +### Page/Data PR Checklist                                                                                                                                                                       
    156   +- [ ] Data fetched in `+page(.server).ts` with minimal payload.                                                                                                                                  
    157   +- [ ] Redirects/errors via `redirect()` / `error()`.                                                                                                                                             
    158   +- [ ] Mutations via actions; forms enhanced progressively.                                                                                                                                       
    159   +- [ ] Caching/invalidation considered (`cache-control`, `depends()`).                                                                                                                            
    161   +---                                                                                                                                                                                              
    163   +Adopt these incrementally: touch files you modify, don’t sweep the repo. Start with navigation, header, and auth flows for maximum impact. 