Goal: Make auth flows reliable in Vercel, consolidate UI to packages/ui, restore CSRF, and harden accessibility and performance, while keeping 
changes surgical.                                                                                                                                
- Phase P0 — Quick Wins                                                                                                                          
    - Restore login flow:                                                                                                                        
    - Remove emergency redirect in `(auth)/login/+page.server.ts` load.                                                                          
    - Keep `signin` action as-is with Superforms; ensure proper `fail(...)` and `redirect(303, ...)` paths.                                      
    - DoD: `/login` renders form; POST `?/signin` produces 303 on success, 400 with inline errors on failure.                                    
- Signup email redirect:                                                                                                                         
    - Ensure `emailRedirectTo` uses `PUBLIC_SITE_URL || url.origin` (already present); verify with logs.                                         
    - DoD: Email link uses correct absolute origin in Preview/Prod.                                                                              
- Env parity in Vercel:                                                                                                                          
    - Set `PUBLIC_SUPABASE_URL`, `PUBLIC_SUPABASE_ANON_KEY`, `PUBLIC_SITE_URL`, and server-only keys in both Preview and Production.             
    - DoD: No 500s at root; hooks initialize Supabase successfully; auth calls succeed.                                                          
- Supabase Redirect URLs:                                                                                                                        
    - Supabase Dashboard → Auth → URL config: include prod domain and all preview patterns.                                                      
    - DoD: OAuth/email callbacks return to correct domain in Preview/Prod.                                                                       
- CSRF:                                                                                                                                          
    - After verifying flows, set `csrf.checkOrigin: true` in `apps/web/svelte.config.js`.                                                        
    - DoD: Forms continue to work with Superforms; non-form POST APIs protected.                                                                 
- Logging:                                                                                                                                       
    - Keep structured logs in Preview; reduce noise for Production (keep errors and essential breadcrumbs).                                      
- Phase P1 — Refactor & Consolidation                                                                                                            
    - Cookie Consent:                                                                                                                            
    - Canonicalize in `packages/ui`; expose variants via props.                                                                                  
    - Replace app-local usage; remove duplicates.                                                                                                
    - DoD: Single implementation used; config/consent cookie unified; accessible and keyboard-friendly.                                          
- UI Primitives:                                                                                                                                 
    - Replace local equivalents with `packages/ui` Button/Card/Input where applicable.                                                           
    - DoD: Imports standardized; no unused local primitives remain.                                                                              
    - Keep redirect logic centralized (root server layout + `authGuard` in hooks).
    - Avoid redundant profile fetches; rely on SSR hooks and pass-through data.
    - DoD: Fewer fetches; clear responsibility boundaries.
- Runes/Stores:
    - Normalize Svelte 5 runes usage across new code.
    - Audit stores for SSR safety and hydration patterns; ensure `depends('supabase:auth')` used where needed.
    - DoD: No hydration warnings; predictable store state across SSR/CSR.
- Phase P2 — Hardening
    - Accessibility:
    - Forms: Label/description associations, error summaries, focus on submit failure.
    - Dialogs: Focus trap, aria attributes, keyboard navigation.
    - Nav/Header: Tab order, skip links if applicable.
    - DoD: Manual keyboard test passes; no critical a11y violations.
- Performance:
    - Code-split heavy components in root `+page.svelte`; lazy-load dialogs and non-critical widgets.
    - Optimize images via `OptimizedImage` and appropriate sizes.
    - DoD: Reduced hydration cost; improved Lighthouse/Pagespeed metrics.
- Error handling & Observability:
    - Standard server error returns; keep Sentry optional and gated by DSN.
    - Sensitive data filtering in error paths.
    - DoD: Clear, user-friendly errors; safe logs; optional Sentry captures in production only.
- Minimal tests:
    - Add integration tests around auth actions and protected route gating.
    - DoD: Green test runs for these flows locally/CI.
- Task List (concrete)
    - Login: Remove /login-temp emergency redirect; re-enable normal login page load.
    - Signup: Verify emailRedirectTo construction; keep PUBLIC_SITE_URL fallback; confirm profile insert idempotency.
    - CSRF: Toggle checkOrigin back to true after verification.
    - Cookie Consent: Implement canonical packages/ui component with variants; migrate usage.
    - Layout/SSR: Keep session/profile from hooks; avoid creating duplicate clients mid-tree.
    - Performance: Split root page modules; lazy-load heavy dialogs; confirm dynamic imports.
- Acceptance Criteria per Task
    - Before/After: Document functional change and files touched.
    - Verification: Manual steps (route, submit, observe redirects/messages), add or update tests when applicable.
    - Quality: No new warnings/errors in dev or build, SSR works in Vercel, aligned with Svelte 5/Kit 2 idioms.
- Manual Verification Matrix
    - Local:
    - Ensure envs present; repeat local checks; check Network panel for `?/signin` and `?/signup`.
    - Verify email callback back to preview domain completes session.
- Production:
    - Repeat preview checks; verify redirects and session completion.
- Risks & Rollback
    - Env drift between Preview and Production → keep envs in sync and redeploy both.
    - If CSRF re-enable blocks forms, temporarily disable and inspect Referer/Origin headers; ensure Superforms CSRF is active.
    - Keep login-temp page around until live verification; remove once stable.